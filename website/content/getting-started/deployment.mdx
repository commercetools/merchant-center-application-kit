---
id: getting-started-deployment
title: Deployment - Getting started
permalink: /getting-started/deployment
---

import { ContentNotification } from '@commercetools-frontend/ui-kit';

<ContentNotification type="info">
  This feature is marked as `beta` and may be affected by changes. Use with caution for production.
</ContentNotification>

# Deploying a Merchant Center application

After you've begun developing your application, it's time to think about deployment for testing and production purposes. This section introduces what you need to do to prepare your application for production deployment, and provides deployment examples.

## Prepare the application for production use

In order to run the application in `production` mode, we need to **build** it using the following command:

```
$ yarn build
```

![Production build](/assets/custom-applications/mc-dev-yarn-build.png)

The `yarn build` command creates a `/dist` directory containing all the generated **JavaScript** and **CSS** bundles. Most of the files are artifacts of the `<ApplicationShell>` due to [Code-Splitting](https://reactjs.org/docs/code-splitting.html).

The command also generates a file named `index.html.template`. This file is generated by webpack and contains references to the bundles, for example:

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <link href="__CDN_URL__17.app.988cd155551de3c7e71c.css" rel='stylesheet' type='text/css' /></link>
    <!-- other elements -->
  </head>
  <body>
    <div id="app"></div>
    <!-- other elements -->
    <script src="__CDN_URL__runtime~app.47483a5f2f8fed96e937.js"></script>
  </body>
</html>
```

Eventually, **this file is transformed** into `index.html` and is served by the application HTTP server.

## Production HTTP Server

We **recommend using** our [`@commercetools-frontend/mc-http-server`](https://www.npmjs.com/package/@commercetools-frontend/mc-http-server) package to run the application in `production` mode.

The [`@commercetools-frontend/mc-http-server`](https://www.npmjs.com/package/@commercetools-frontend/mc-http-server) has built-in functionality that is necessary for the application to work. Most importantly:

- Compiling the `index.html.template` into `index.html` (to inject the runtime configuration in the `env.json` file).
- Preparing the **HTTP response headers**, including the custom `csp.json` configuration (**Content Security Policy**).

The package comes with a binary `mc-http-server` that sets up all the necessary configurations and starts a small Node.JS server.

```
$ mc-http-server --config $(pwd)/env.json --csp $(pwd)/csp.json
```

### Docker image

There is also a pre-built **Docker image** (`eu.gcr.io/ct-images/mc-http-server`) that you can use to run the application:

```
$ docker pull eu.gcr.io/ct-images/mc-http-server
$ docker run \
  -v $(pwd):/etc/app \
  -p 8080:8080 \
  eu.gcr.io/ct-images/mc-http-server \
  --config /etc/app/env.json \
  --csp /etc/app/csp.json
```

The version of the **Docker image** is the same as the [last release of the `merchant-center-application-kit`](https://github.com/commercetools/merchant-center-application-kit/releases).

### Configuring `env.json`

When you start the `mc-http-server`, you need to pass a `--config` option pointing to the path of `env.json`.

> Note: For `development` this configuration is **required**. The `env.json` file must be in the root path of the project and is automatically loaded by the webpack dev-server.

The `env.json` file contains runtime configuration available as a global state, `window.app`. The `window.app` object is passed to the `<ApplicationShell>` component as an `environment` prop. The `window.app` object may contain any configuration specific to the application, plus the following **required** fields:

- `frontendHost`: The host where the Merchant Center custom application is running (e.g. `mc.commercetools.com`)
- `mcApiUrl`: The API URL for the [Merchant Center API Gateway](../api-gateway)
- `location`: The location where the Merchant Center custom application is running. This is either:
  - `eu` for projects in **Europe**
  - `us` for projects in the **United States**.
- `env`: The environment where the Merchant Center custom application is running, usually `production`, `staging` or `development`.
- `cdnUrl`: The URL where the static assets are stored (see [Serving static assets](#serving-static-assets)).
- `servedByProxy`: A flag to indicate if the application is running behind the Merchant Center Proxy or not. This is either:
  - `true` for **production**
  - `false` for **local development**

We recommend to use the `env.json` file in the [project starter example](https://github.com/commercetools/merchant-center-application-kit/tree/master/application-templates/starter) as a starting point.

### Configuring `csp.json`

When you start the `mc-http-server`, you need to pass a `--csp` option pointing to the path of `csp.json`.

> Note: For `development` this configuration is **optional**. If you use it, the `csp.json` file must be in the root path of the project and is automatically loaded by the webpack dev-server.

The `csp.json` file contains additional directives for [Content Security Policy](https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP) which are specific to the domain hosting the app. This is necessary as the custom application runs on a different server/domain. Furthermore, static assets (see [Serving static assets](#serving-static-assets)) are also served from a domain that is not `*.commercetools.com`, which means we need to add those URLs to the CSP whitelist in order for the browser to be able to load the resources.

For `production`, we recommended defining at a minimum the following directives, where `my-apps.com` is the domain hosting the Custom Application:

```json
{
  "script-src": ["my-apps.com"],
  "connect-src": ["my-apps.com"],
  "style-src": ["my-apps.com"]
}
```

You can find the list of default directives in the `load-headers.js` file in the `@commercetools-frontend/mc-html-template` package.

## Serving static assets

When you start the HTTP server, you need to make a decision where to host **CSS** and **JavaScript** assets. There are two choices:

- Upload the static assets to a remote CDN (Content Delivery Network) or Cloud Storage (**recommended**).
- Keep the static assets on the HTTP server.

We strongly recommend uploading static assets to a **remote CDN or Cloud Storage** if possible. This prevents broken references.

A broken reference is when a file is requested by the browser which is no longer found on the server. It often happens during application re-deploys. For example, imagine if a user has the Merchant Center opened. The `index.html` page contains references to the static assets, for example, `app.v1.js`. If we have the static assets served by the HTTP server, when a new version of the application is deployed, the `app.v1.js` file is no longer present on the HTTP server. If the user performs an action without reloading the browser, there is a chance that the `app.v1.js` file is requested by the browser, is unavailable, and causes a runtime error. If the static assets are uploaded to a remote CDN or Cloud Storage instead, uploading new versions of the application don't affect old versions still receiving outdated assets. When a user reloads the page, their browser requests the new assets, and the application launch is seamless.

### Serving assets on a remote CDN or Cloud Storage

First, upload the assets from `dist/assets` directory to a CDN or Cloud Storage. Then define the location URL of the storage directory in the `cdnUrl` in the `env.json`.

For example, Merchant Center static assets are uploaded to a Google Cloud Storage bucket named `mc-production-eu` for the `eu` region's production assets. Then simply reference the URL in `cdnUrl` in the `env.json.`

```json
{
  "cdnUrl": "https://storage.googleapis.com/mc-production-eu"
}
```

### Serving assets using the HTTP server

> We do not recommend serving assets using the HTTP server for production use.

To serve static assets in using the HTTP server, do the following:

- Include the `/dist` directory in the project or in the Docker container.
- Explicitly enable this option when running the `mc-http-server` by passing the `--use-local-assets` flag.
- In the `env.json` file, set the `cdnUrl` to the **root domain** where the server is hosted. For example, if the application is hosted at `https://my-custom-app.com`, the `cdnUrl` should be `https://my-custom-app.com`.

## Deployment examples

It's up to you to choose the deployment strategy and where the application will be hosted. Here are some examples to help you with the configuration.

You can deploy a custom application to any Cloud Provider or service of your choice, either as a NodeJS process or as a Docker container.

If you would like to see deployment examples for other Cloud Providers, please let us know by contacting [platform support](https://support.commercetools.com).

### Now

This deployment example refers to the [Now serverless deployment](https://zeit.co/now).

There are different deployment strategies but we will focus on deployments using **Docker containers**.

> Note: that the setup currently works for `now` version `1`. The version `2` has deprecated those deployment types and is based on **Lambda** functions (or static files) to run the application. **If requested, we will look into it and provide a tutorial for setting it up.**

#### Prerequisites

Before you get started, you need to have:

- A [Now](https://zeit.co/signup) account
- The [Now Desktop](https://zeit.co/download) or [Now CLI](https://zeit.co/download#now-cli) applications
- [Docker](https://docs.docker.com/install/) installed

We're going to deploy the application under the domain `mc-examples-starter.now.sh`.

> Note: The `mc-examples-starter.now.sh` domain is already in use. Pick a different one if you choose to deploy using Now.

#### Configuration

The first thing to do is to define a `now.json` file to configure the deployment with the following JSON:

```json
{
  "version": 1,
  "public": true,
  "name": "mc-examples-starter",
  "alias": "mc-examples-starter",
  "regions": ["bru"],
  "files": ["dist", "csp.json", "env.prod.json", "now.json", "package.json"]
}
```

Some fields may vary based on your setup and requirements (e.g. `public`, `regions`).

The `files` field determines the list of files for uploading to the cloud servers. The`env.prod.json` file, contains the configuration for **production** use, to differentiate it from the `env.json` used for **development**.

Next, we need to create an `env.prod.json` file with the following JSON:

```json
{
  "frontendHost": "mc-examples-starter.now.sh",
  "mcApiUrl": "https://mc-api.commercetools.com",
  "location": "eu",
  "env": "production",
  "cdnUrl": "http://mc-examples-starter.now.sh",
  "servedByProxy": true
}
```

We also need a `csp.json` file. You can also have a `csp.prod.json` file if you want to use a different configuration for `development`.

```json
{
  "script-src": ["mc-examples-starter.now.sh"],
  "connect-src": ["mc-examples-starter.now.sh"],
  "style-src": ["mc-examples-starter.now.sh"]
}
```

As a next step, we need a `Dockerfile` which contains the runtime configuration for starting the HTTP server:

```docker
FROM node:10-stretch

WORKDIR /app

COPY ./dist /app/dist

COPY ./package.json /app/
RUN yarn install --production

COPY ./csp.json /app/
COPY ./env.prod.json /app/

ENV NODE_ENV=production

EXPOSE 3001

CMD /app/node_modules/.bin/mc-http-server --config /app/env.prod.json --csp /app/csp.json --use-local-assets
```

For the sake of the example, the setup includes the static assets within the HTTP server as described [here](#serving-assets-using-the-http-server). For **real production use** we recommend uploading static assets to a CDN or Cloud Storage as described [here](#serving-assets-on-a-remote-cdn-or-cloud-storage).

We also assume that the assets are built first with `yarn build` and then **copied** into the Docker image (`COPY ./dist /app/dist`).

#### Deployment

Finally, we can trigger the deployment using the [Now CLI](https://zeit.co/download#now-cli):

```
$ yarn build

$ now --docker

$ now alias
```

![Now deploy - part 1](/assets/custom-applications/mc-dev-now_1.png)
![Now deploy - part 2](/assets/custom-applications/mc-dev-now_2.png)
![Now alias](/assets/custom-applications/mc-dev-now-alias.png)

If we go to `https://mc-examples-starter.now.sh` we can see the application loading and we can inspect the Developer Console to see that the configuration is correct:

![Now deployed](/assets/custom-applications/mc-dev-now-deployed.png)

However, if you try to log in, you will get an error:

![Now login failed](/assets/custom-applications/mc-dev-now-login-failed.png)

**This is expected**. The domain `mc-examples-starter.now.sh` **is not allowed by the CORS rules** defined in the [Merchant Center API Gateway](../api-gateway). It's a security measure as the Custom Application should only be served behind the Merchant Center Proxy.

Now you're ready to [Register your Custom Application](./registration) and start using it!
